steps:

    #
    # Building
    #
    - name: 'gcr.io/cloud-builders/docker'
      entrypoint: 'bash'
      args:
      - '-c'
      - |
        docker pull eu.gcr.io/$PROJECT_ID/pyslo-builder:latest || exit 0    
  
    - id: build-builder
      name: gcr.io/cloud-builders/docker
      dir: cloudbuild/
      args: [
                'build',
                '--rm=false',
                '-t','eu.gcr.io/$PROJECT_ID/pyslo-builder:latest',
                '--cache-from', 'eu.gcr.io/$PROJECT_ID/pyslo-builder:latest',
                '-f', './Dockerfile', '.'
        ]
    
    #
    # Testing
    #

    - id: test
      name: eu.gcr.io/$PROJECT_ID/pyslo-builder:latest
      args: ['cloudbuild/scripts/test.sh']
      waitFor:
        - build-builder

    - id: build-package
      name: eu.gcr.io/$PROJECT_ID/pyslo-builder:latest
      args: ['cloudbuild/scripts/build.sh']
      waitFor:
        - test        

images: ['eu.gcr.io/$PROJECT_ID/pyslo-builder:latest']